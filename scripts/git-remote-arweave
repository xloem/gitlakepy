#!/usr/bin/env python3

import json
import requests

GATEWAY_URI='https://arweave.net'

def yield_all(uri, Type):
	session = requests.Session()
	cursor = ''
	while True:
		resp = session.post(uri + '/graphql',
			json={'query':'''
				query {
					transactions(
						tags: [
							{ name: "Type", values: [''' + json.dumps(Type) + '''] }
						]
						after: ''' + json.dumps(cursor) + '''
					) {
						edges {
							node {
								id
								owner {
									address
								}
								tags {
									name
									value
								}
							}
							cursor
						}
					}
				}
			'''}
		)
		data = resp.json()
		if 'data' not in data:
			raise Exception(data)
		edges = data['data']['transactions']['edges']
		if not len(edges):
			break
		for edge in edges:
			cursor = edge['cursor']
			node = edge['node']
			data = session.get(uri + '/' + edge['node']['id'])
			try:
				data = data.json()
			except:
				data = data.text
			yield dict(
				txid = node['id'],
				owner = node['owner']['address'],
				tags = {tag['name']: tag['value'] for tag in node['tags']},
				data = data,
			)

for obj in yield_all(GATEWAY_URI, 'update-ref'):
	print(obj)

raise Exception('===> This is just a prototype to show git updates from arweave. <===')

